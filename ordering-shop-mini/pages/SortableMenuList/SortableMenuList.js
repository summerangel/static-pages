Page({
  data: {
    currIndex: 0,
    dragLayerShow: true,
    optionsListData: [
      {
        // "sCode": "600879", 
        // "sDtSecCode": "0101600879", 
        // "sName": "航天电子", 
        // "iUpdateTime": 1496362315, 
        // "fNow": "--", 
        // "sRate": "--", 
        "categoryId": 0,
        "className": "block_wave block_stop",

        "isExpand": false,
        "cateName": "热销榜单",
        "cateNum": 6,
        "goodsList": [
          {
            "goodsImage": "http://fuss10.elemecdn.com/c/cd/c12745ed8a5171e13b427dbc39401jpeg.jpeg?imageView2/1/w/114/h/114",
            "goodsName": "招牌红烧排骨",
            "goodsPrice": 55
          }, {
            "goodsImage": "http://fuss10.elemecdn.com/c/6b/29e3d29b0db63d36f7c500bca31d8jpeg.jpeg?imageView2/1/w/114/h/114",
            "goodsName": "特色油炸桂鱼",
            "goodsPrice": 25.9
          }, {
            "goodsImage": "http://fuss10.elemecdn.com/f/28/a51e7b18751bcdf871648a23fd3b4jpeg.jpeg?imageView2/1/w/114/h/114",
            "goodsName": "精品时蔬茼蒿",
            "goodsPrice": 25.9
          }
        ]
      }, {
        // "sCode": "00700",
        // "sDtSecCode": "0101600878",
        // "sName": "腾讯控股",
        // "iUpdateTime": 1496362343,
        // "fNow": "--",
        // "sRate": "--",
        "categoryId": 1,
        "className": "block_wave block_stop",

        "isExpand": false,
        "cateName": "开胃凉菜",
        "cateNum": 3,
        "goodsList": [
          {
            "goodsImage": "http://fuss10.elemecdn.com/c/cd/c12745ed8a5171e13b427dbc39401jpeg.jpeg?imageView2/1/w/114/h/114",
            "goodsName": "招牌红烧排骨",
            "goodsPrice": 55
          }, {
            "goodsImage": "http://fuss10.elemecdn.com/c/6b/29e3d29b0db63d36f7c500bca31d8jpeg.jpeg?imageView2/1/w/114/h/114",
            "goodsName": "特色油炸桂鱼",
            "goodsPrice": 25.9
          }, {
            "goodsImage": "http://fuss10.elemecdn.com/f/28/a51e7b18751bcdf871648a23fd3b4jpeg.jpeg?imageView2/1/w/114/h/114",
            "goodsName": "精品时蔬茼蒿",
            "goodsPrice": 25.9
          }
        ]
      }, {
        // "sCode": "600879",
        // "sDtSecCode":
        // "0101600879",
        // "sName": "航天电子",
        // "iUpdateTime": 1496362315,
        // "fNow": "--",
        // "sRate": "--",
        "categoryId": 2,
        "className": "block_wave block_stop",

        "isExpand": false,
        "cateName": "面食汤点",
        "cateNum": 5,
        "goodsList": [
          {
            "goodsImage": "http://fuss10.elemecdn.com/c/cd/c12745ed8a5171e13b427dbc39401jpeg.jpeg?imageView2/1/w/114/h/114",
            "goodsName": "招牌红烧排骨",
            "goodsPrice": 55
          }, {
            "goodsImage": "http://fuss10.elemecdn.com/c/6b/29e3d29b0db63d36f7c500bca31d8jpeg.jpeg?imageView2/1/w/114/h/114",
            "goodsName": "特色油炸桂鱼",
            "goodsPrice": 25.9
          }, {
            "goodsImage": "http://fuss10.elemecdn.com/f/28/a51e7b18751bcdf871648a23fd3b4jpeg.jpeg?imageView2/1/w/114/h/114",
            "goodsName": "精品时蔬茼蒿",
            "goodsPrice": 25.9
          }
        ]
      }, {
        // "sCode": "600879",
        // "sDtSecCode":
        // "0101600879",
        // "sName": "航天电子",
        // "iUpdateTime": 1496362315,
        // "fNow": "--",
        // "sRate": "--",
        "categoryId": 3,
        "className": "block_wave block_stop",

        "isExpand": false,
        "cateName": "精品热菜",
        "cateNum": 9,
        "goodsList": [
          {
            "goodsImage": "http://fuss10.elemecdn.com/c/cd/c12745ed8a5171e13b427dbc39401jpeg.jpeg?imageView2/1/w/114/h/114",
            "goodsName": "招牌红烧排骨",
            "goodsPrice": 55
          }, {
            "goodsImage": "http://fuss10.elemecdn.com/c/6b/29e3d29b0db63d36f7c500bca31d8jpeg.jpeg?imageView2/1/w/114/h/114",
            "goodsName": "特色油炸桂鱼",
            "goodsPrice": 25.9
          }, {
            "goodsImage": "http://fuss10.elemecdn.com/f/28/a51e7b18751bcdf871648a23fd3b4jpeg.jpeg?imageView2/1/w/114/h/114",
            "goodsName": "精品时蔬茼蒿",
            "goodsPrice": 25.9
          }
        ]
      }, {
        // "sCode": "600879",
        // "sDtSecCode":
        // "0101600879",
        // "sName": "航天电子",
        // "iUpdateTime": 1496362315,
        // "fNow": "--",
        // "sRate": "--",
        "categoryId": 4,
        "className": "block_wave block_stop",

        "isExpand": false,
        "cateName": "饭后水果",
        "cateNum": 2,
        "goodsList": [
          {
            "goodsImage": "http://fuss10.elemecdn.com/c/cd/c12745ed8a5171e13b427dbc39401jpeg.jpeg?imageView2/1/w/114/h/114",
            "goodsName": "招牌红烧排骨",
            "goodsPrice": 55
          }, {
            "goodsImage": "http://fuss10.elemecdn.com/c/6b/29e3d29b0db63d36f7c500bca31d8jpeg.jpeg?imageView2/1/w/114/h/114",
            "goodsName": "特色油炸桂鱼",
            "goodsPrice": 25.9
          }, {
            "goodsImage": "http://fuss10.elemecdn.com/f/28/a51e7b18751bcdf871648a23fd3b4jpeg.jpeg?imageView2/1/w/114/h/114",
            "goodsName": "精品时蔬茼蒿",
            "goodsPrice": 25.9
          }
        ]
      }
    ],
    movableViewPosition: {
      x: 0,
      y: 0,
      className: "none",
      data: {}
    }, //记录选中的要拖拽的项
    scrollPosition: {
      everyOptionCell: 62,
      top: 67,
      scrollTop: 0,
      scrollY: true,
      scrollViewHeight: 1000,
      scrollViewWidth: 375,
      windowViewHeight: 1000,
    },
    selectItemInfo: {
      // sName: "",
      // sDtSecCode: "",
      // sCode: "",
      selectIndex: -1,
      selectPosition: 0,

      isExpand: false,
      cateName: '热销榜单',
      cateNum: 6,
      goodsList: [
        {
          goodsImage: "http://fuss10.elemecdn.com/c/cd/c12745ed8a5171e13b427dbc39401jpeg.jpeg?imageView2/1/w/114/h/114",
          goodsName: '招牌红烧排骨',
          goodsPrice: 55
        }, {
          goodsImage: "http://fuss10.elemecdn.com/c/6b/29e3d29b0db63d36f7c500bca31d8jpeg.jpeg?imageView2/1/w/114/h/114",
          goodsName: '特色油炸桂鱼',
          goodsPrice: 25.9
        }, {
          goodsImage: "http://fuss10.elemecdn.com/f/28/a51e7b18751bcdf871648a23fd3b4jpeg.jpeg?imageView2/1/w/114/h/114",
          goodsName: '精品时蔬茼蒿',
          goodsPrice: 25.9
        }
      ]
    },

    recommentContent: '确定设置“特色油炸桂鱼”为推荐菜？'
  },

  tabSelect(e) {
    const index = e.currentTarget.dataset.index;
    this.setData({
      currIndex: index
    })
  },

  cateTapHandler(e) {
    const index = e.currentTarget.dataset.parentindex;
    const optionsListData = this.data.optionsListData;
    optionsListData[index].isExpand = !optionsListData[index].isExpand;
    this.setData({
      optionsListData
    })
    this.checkIsDragable();
  },

  shelfGoods() {
    this.showDialog();
  },

  showDialog() {
    this.dialog.showDialog();
  },

  //取消事件
  _cancelEvent() {
    console.log('你点击了取消');
    this.dialog.hideDialog();
  },

  //确认事件
  _confirmEvent() {
    console.log('你点击了确定');
    this.dialog.hideDialog();
  },

  // 新增推荐弹框 start
  showRecommendDialog(e) {
    const goodsName = e.currentTarget.dataset.name;
    console.log('e', e);
    this.setData({
      recommentContent: `确定设置"${goodsName} "为推荐菜？`
    })
    this.recommend.showDialog();
  },

  //取消事件
  _cancelRecommendEvent() {
    console.log('你点击了推荐取消');
    this.recommend.hideDialog();
  },

  //确认事件
  _confirmRecommendEvent() {
    console.log('你点击了推荐确定');
    this.recommend.hideDialog();
  },
  //新增推荐弹框 end

  bindscroll: function (event) {
    var scrollTop = event.detail.scrollTop;
    this.setData({
      'scrollPosition.scrollTop': scrollTop
    })
  },

  getOptionInfo: function (code) {
    for (var i = 0, j = this.data.optionsListData.length; i < j; i++) {
      var optionData = this.data.optionsListData[i];
      if (optionData.categoryId == code) {
        optionData.selectIndex = i;
        return optionData;
      }
    }
    return {};
  },

  getPositionDomByXY: function (potions) {
    var y = potions.y - this.data.scrollPosition.top + this.data.scrollPosition.scrollTop;
    var optionsListData = this.data.optionsListData;
    var everyOptionCell = this.data.scrollPosition.everyOptionCell;
    for (var i = 0, j = optionsListData.length; i < j; i++) {
      if (y >= i * everyOptionCell && y < (i + 1) * everyOptionCell) {
        return optionsListData[i];
      }
    }
    return optionsListData[0];
  },
  
  // 检查是否可拖拽，当有一项是展开时，禁止拖拽功能
  checkIsDragable() {
    let isDragable = false;
    const optionsListData = this.data.optionsListData;
    if (optionsListData.length > 0) {
      isDragable = !!(optionsListData.filter((item) => { return item.isExpand; })).length;
    }

    this.setData({
      dragLayerShow: !isDragable
    })
  },

  draggleTouch: function (event) {
    // if (this.checkIsDragable()) {
    //   this.setData({
    //     dragLayerShow: false
    //   })
    //   return;
    // } else {
    //   this.setData({
    //     dragLayerShow: true
    //   })
    // }
    var touchType = event.type;
    switch (touchType) {
      case "touchstart":
        this.scrollTouchStart(event);
        break;
      case "touchmove":
        this.scrollTouchMove(event);
        break;
      case "touchend":
        this.scrollTouchEnd(event);
        break;
    }
  },

  scrollTouchStart: function (event) {
    // console.log(event);
    var firstTouchPosition = {
      x: event.changedTouches[0].pageX,
      y: event.changedTouches[0].pageY,
    }
    console.log("firstTouchPosition:", firstTouchPosition);
    var domData = this.getPositionDomByXY(firstTouchPosition);
    console.log("domData:", domData);

    //movable-area滑块位置处理
    var movableX = 0;
    var movableY = firstTouchPosition.y - this.data.scrollPosition.top - this.data.scrollPosition.everyOptionCell / 2;

    this.setData({
      movableViewPosition: {
        x: movableX,
        y: movableY,
        className: "",
        data: domData
      }
    })

    var categoryId = domData.categoryId;
    var selectItemInfo = this.getOptionInfo(categoryId);
    selectItemInfo.selectPosition = event.changedTouches[0].clientY;
    selectItemInfo.selectClass = "dragSelected";

    this.data.optionsListData[selectItemInfo.selectIndex].selectClass = "dragSelected";

    var optionsListData = this.data.optionsListData;

    this.setData({
      selectItemInfo,
      optionsListData,
      'scrollPosition.scrollY': false,
      'scrollPosition.selectIndex': selectItemInfo.selectIndex
    })
  },

  scrollTouchMove: function (event) {
    var selectItemInfo = this.data.selectItemInfo;
    var selectPosition = selectItemInfo.selectPosition;
    var moveDistance = event.changedTouches[0].clientY;
    var everyOptionCell = this.data.scrollPosition.everyOptionCell;
    var optionsListData = this.data.optionsListData;
    var selectIndex = selectItemInfo.selectIndex;

    console.log("event.changedTouches:", event.changedTouches);
    //movable-area滑块位置处理
    var movableX = 0;
    var movableY = event.changedTouches[0].pageY - this.data.scrollPosition.top - this.data.scrollPosition.everyOptionCell / 2;


    this.setData({
      movableViewPosition: {
        x: movableX,
        y: movableY,
        className: "",
        data: this.data.movableViewPosition.data
      }
    })

    if (moveDistance - selectPosition > 0 && selectIndex < optionsListData.length - 1) {
      if (optionsListData[selectIndex].categoryId == selectItemInfo.categoryId) {
        optionsListData.splice(selectIndex, 1);
        optionsListData.splice(++selectIndex, 0, selectItemInfo);
        selectPosition += everyOptionCell;
      }
    }

    if (moveDistance - selectPosition < 0 && selectIndex > 0) {
      if (optionsListData[selectIndex].categoryId == selectItemInfo.categoryId)       {
        optionsListData.splice(selectIndex, 1);
        optionsListData.splice(--selectIndex, 0, selectItemInfo);
        selectPosition -= everyOptionCell;
      }
    }

    this.setData({
      optionsListData,
      'selectItemInfo.selectPosition': selectPosition,
      'selectItemInfo.selectIndex': selectIndex
    });
  },

  scrollTouchEnd: function (event) {
    console.log('scrollTouchEnd', event);
    var optionsListData = this.optionsDataTranlate(this.data.optionsListData, "");

    this.setData({
      optionsListData,
      'scrollPosition.scrollY': true,
      'movableViewPosition.className': "none"
    })
  },

  optionsDataTranlate: function (optionsList, selectClass) {
    for (var i = 0, j = optionsList.length; i < j; i++) {
      optionsList[i].selectClass = selectClass;
    }
    return optionsList;
  },

  onLoad: function (options) {
    var systemInfo = wx.getSystemInfoSync();
    var optionsListData = this.data.optionsListData;
    optionsListData = this.optionsDataTranlate(optionsListData, "");
    // 开始加载页面
    var scrollViewHeight = systemInfo.windowHeight - 67;
    var scrollViewWidth = systemInfo.windowWidth;
    this.setData({
       optionsListData,
      'scrollPosition.scrollViewWidth': scrollViewWidth,
      'scrollPosition.scrollViewHeight': scrollViewHeight,
      'scrollPosition.windowViewHeight': systemInfo.windowHeight,
    });
  },
  onShow: function () {
    // 页面显示
    console.log("onShow");

  },
  onReady: function () {
    // 页面渲染完成
    console.log("onReady");
    this.dialog = this.selectComponent("#dialog");
    this.recommend = this.selectComponent("#recommend");
  },
  onHide: function () {
    console.log(22);


    // 页面隐藏
    console.log("onHide");
  },
  onUnload: function () {
    // 页面关闭
    console.log("onUnload");
  },
});
